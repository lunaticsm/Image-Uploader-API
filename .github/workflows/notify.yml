name: 🚀 GitHub to Telegram Notification

on:
  push:
    branches-ignore:
      - 'dependabot/**'  # Optional: skip bot commits

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: 📩 Send Telegram Notification
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_TO }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          # Validate required secrets
          if [ -z "$TELEGRAM_CHAT_ID" ] || [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "⚠️ Missing TELEGRAM_TO or TELEGRAM_TOKEN secret. Skipping notification."
            exit 0
          fi

          # Extract event data
          USER="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_URL="https://github.com/${REPO}/commit/${COMMIT_SHA}"
          PROFILE_URL="https://github.com/${USER}"

          # Format timestamp in JST (UTC+9)
          JST_TIMESTAMP=$(TZ="Asia/Tokyo" date -d "${{ github.event.head_commit.timestamp }}" "+%Y-%m-%d %H:%M:%S JST" 2>/dev/null || echo "Unknown time")

          # Get total commit count (fallback to "N/A" if failed)
          TOTAL_COMMITS=$(curl -s "https://api.github.com/repos/${REPO}/commits?per_page=1" | jq -r 'length // "N/A"' 2>/dev/null)

          # Escape special Markdown characters in commit message
          ESCAPED_MSG=$(printf '%s' "$COMMIT_MSG" | sed 's/[_*[\]()~`>#+\-=|{}.!]/\\&/g')

          # Build message
          MESSAGE="🚀 *New Commit Pushed!*

———————————————
🏷️ *Commit by:* \`${USER}\`
📂 *Repository:* \`${REPO}\`
🌿 *Branch:* \`${BRANCH}\`
🛠️ *Total Commits:* \`${TOTAL_COMMITS}\`
⏳ *Pushed at:* \`${JST_TIMESTAMP}\`
———————————————

📝 *Commit Message:*
\`\`\`
${ESCAPED_MSG}
\`\`\`"

          # Send to Telegram
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"${MESSAGE}\",
              \"parse_mode\": \"MarkdownV2\",
              \"disable_web_page_preview\": true,
              \"reply_markup\": {
                \"inline_keyboard\": [
                  [{\"text\": \"👤 View Profile\", \"url\": \"${PROFILE_URL}\"}],
                  [{\"text\": \"🔗 View Commit\", \"url\": \"${COMMIT_URL}\"}]
                ]
              }
            }")

          # Check response
          if [ "$RESPONSE" -ne 200 ]; then
            echo "❌ Telegram notification failed (HTTP $RESPONSE). See response.json"
            cat response.json
            exit 1
          else
            echo "✅ Notification sent successfully!"
          fi